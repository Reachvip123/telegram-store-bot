# -*- coding: utf-8 -*-
import os
import qrcode
import logging
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
from bakong_khqr import KHQR

# --- ⚙️ YOUR DETAILS ⚙️ ---
TELEGRAM_BOT_TOKEN = "8197112968:AAFGBGjBRFmJzSe-UEKww3DJsFF9woa1wtY"
BAKONG_API_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoiNmY0ZjUwNmY3Y2I5NDM0ZiJ9LCJpYXQiOjE3NTc1Mjg3MzksImV4cCI6MTc2NTMwNDczOX0.UOayVvH-pL0NnYSnzJwmYZU9V6hlcFNeIB0q6zIXNVA"
BAKONG_ACCOUNT_ID = "011442963"
BAKONG_MERCHANT_NAME = "SOVANNAREACH VORN"
# --- End of Configuration ---


# --- Logging Setup (for debugging) ---
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- KHQR Instance ---
try:
    khqr_instance = KHQR(BAKONG_API_TOKEN)
except Exception as e:
    logger.error(f"Failed to initialize KHQR instance. Check your Bakong API Token. Error: {e}")
    khqr_instance = None

# --- Bot Handlers ---

async def start(update: Update, context: CallbackContext) -> None:
    """Sends a welcome message."""
    welcome_text = (
        "Welcome to the KHQR Bot!\n\n"
        "To generate a QR code, send an amount.\n\n"
        "✅ Examples:\n"
        " • `2.50` (for USD)\n"
        " • `10000 KHR` (for Riel)"
    )
    await update.message.reply_text(welcome_text)

async def handle_message(update: Update, context: CallbackContext) -> None:
    """Handles incoming text messages to generate QR codes."""
    if not khqr_instance:
        await update.message.reply_text("⚠️ Bot Error: KHQR service is not initialized. Please check the bot's console logs.")
        return

    message_text = update.message.text
    chat_id = update.message.chat_id

    try:
        parts = message_text.split()
        amount_str = parts[0].replace(',', '')
        amount = float(amount_str)
        currency = "USD"
        if len(parts) > 1 and parts[1].upper() == 'KHR':
            currency = "KHR"
            amount = int(amount)

        if amount <= 0:
            await update.message.reply_text("Please enter an amount greater than zero.")
            return

        await update.message.reply_text(f"⏳ Generating QR for {amount:,} {currency}...")

        # 1. Generate KHQR Data String
        qr_data = khqr_instance.create_qr(
            bank_account=BAKONG_ACCOUNT_ID,
            merchant_name=BAKONG_MERCHANT_NAME,
            merchant_city='Phnom Penh',
            amount=amount,
            currency=currency,
            store_label='Dzstore', # <-- ADDED THIS
            phone_number='012345678', # <-- ADDED THIS (Change if you want)
            terminal_label='Cashier01', # <-- ADDED THIS
            bill_number=f'TMX-{chat_id}-{update.message.message_id}'
        )

        # 2. Generate MD5 Hash to check payment status
        md5_hash = khqr_instance.generate_md5(qr_data)
        logger.info(f"Generated MD5 for transaction: {md5_hash}")

        # 3. Create QR Code Image
        image_path = os.path.join(os.getcwd(), f"qr_{md5_hash}.png")
        qrcode.make(qr_data).save(image_path)

        # 4. Send QR Code to User
        with open(image_path, 'rb') as qr_photo:
            await context.bot.send_photo(
                chat_id=chat_id,
                photo=qr_photo,
                caption=f"Please scan to pay {amount:,} {currency}.\nI will notify you when payment is complete."
            )
        os.remove(image_path) # Clean up the image file

        # 5. Start checking for payment in the background
        context.job_queue.run_once(
            check_payment_status,
            when=10, # Start checking after 10 seconds
            data={'chat_id': chat_id, 'md5': md5_hash, 'amount': amount, 'currency': currency, 'attempts': 0},
            name=f"payment_{md5_hash}"
        )

    except (ValueError, IndexError):
        await update.message.reply_text("Invalid format. Please send the amount like `2.50` or `10000 KHR`.")
    except Exception as e:
        logger.error(f"An error occurred in handle_message: {e}")
        await update.message.reply_text("Sorry, an unexpected error occurred. Please try again.")

async def check_payment_status(context: CallbackContext) -> None:
    """Periodically checks if the transaction has been paid."""
    job = context.job
    data = job.data
    max_attempts = 36 # Check for 6 minutes (36 attempts * 10 seconds)

    if data['attempts'] >= max_attempts:
        await context.bot.send_message(chat_id=data['chat_id'], text=f"The payment request for {data['amount']:,} {data['currency']} has expired.")
        return

    try:
        logger.info(f"Checking payment for MD5: {data['md5']} (Attempt: {data['attempts'] + 1})")
        status = khqr_instance.check_payment(data['md5'])

        if status and status.upper() == "PAID":
            logger.info(f"Payment successful for MD5: {data['md5']}")
            await context.bot.send_message(
                chat_id=data['chat_id'],
                text=f"✅ Payment Received!\n\nThank you for paying {data['amount']:,} {data['currency']}."
            )
        else:
            data['attempts'] += 1
            context.job_queue.run_once(check_payment_status, when=10, data=data, name=job.name)

    except Exception as e:
        logger.error(f"Error checking payment status for MD5 {data['md5']}: {e}")
        if data['attempts'] > 5:
            await context.bot.send_message(chat_id=data['chat_id'], text="There was an issue verifying your payment. Please contact support if you have already paid.")

def main() -> None:
    """Starts the bot."""
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("\nBot is running... Press Ctrl+C to stop.")
    application.run_polling()

if __name__ == '__main__':
    main()

